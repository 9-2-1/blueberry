# 重构计划：分离计算逻辑和渲染逻辑

## 1. 重构目标

- 分离计算逻辑和格式化逻辑
- 统计结果按列分类，方便处理
- 无效数据用null代替，而不是直接格式化
- 统计结果作为prop传入表格，渲染函数放在后面
- 主动判断null值

## 2. 具体重构步骤

### 2.1 重构 `calculations.ts`

- **分离计算和格式化函数**：将所有格式化函数（如formatTime、formatDate）单独放在一个文件或模块中
- **修改计算函数**：返回原始数字，无效数据返回null
- **添加按列分类的统计函数**：创建一个函数，将统计结果按列分类，方便后续处理
- **修改总计函数**：返回原始数字，而不是格式化后的字符串

### 2.2 创建新的类型定义

- **统计结果类型**：定义单个任务的统计结果类型
- **按列分类的统计结果类型**：定义按列分类的统计结果类型
- **总计结果类型**：定义总计结果类型

### 2.3 重构 `TaskTable.svelte`

- **修改props**：接收统计结果作为props，而不是原始数据
- **添加格式化逻辑**：在组件内部处理数据格式化
- **主动判断null值**：在渲染时处理null值，显示适当的占位符
- **按列处理数据**：利用按列分类的统计结果，方便进行批量处理

### 2.4 调整父组件

- **添加统计逻辑**：在父组件中调用统计函数，生成统计结果
- **传递统计结果**：将统计结果作为prop传递给TaskTable组件

## 3. 代码结构设计

### 3.1 新的类型定义

```typescript
// 单个任务的统计结果
export interface 任务统计结果 {
  名称: string;
  已完成: number;
  剩余: number;
  速度: number | null;
  日用时: number | null;
  剩余时间: number | null;
  预计完成时间: number | null;
  颜色?: string;
}

// 按列分类的统计结果
export interface 按列统计结果 {
  名称: string[];
  已完成: number[];
  剩余: number[];
  速度: (number | null)[];
  日用时: (number | null)[];
  剩余时间: (number | null)[];
  预计完成时间: (number | null)[];
  颜色: (string | undefined)[];
}

// 总计结果
export interface 总计结果 {
  总日用时: number | null;
  总剩余时间: number | null;
  预计完成时间: number | null;
  未决任务数: number;
}
```

### 3.2 新的计算函数设计

- `calculateTaskStats`：计算单个任务的统计结果
- `calculateColumnStats`：将任务统计结果转换为按列分类的统计结果
- `calculateTotalStats`：计算总计结果
- `formatTime`：格式化时间
- `formatDate`：格式化日期

### 3.3 新的组件结构

```svelte
<!-- TaskTable.svelte -->
<script lang="ts">
  import type { 按列统计结果, 总计结果 } from '../types';
  import { formatTime, formatDate } from '../utils/formatters';
  import { getThemeColors } from '../utils/color';

  const {
    当前时间,
    列统计结果,
    总计结果,
  }: { 当前时间: Date; 列统计结果: 按列统计结果; 总计结果: 总计结果 } = $props();
</script>

<!-- 渲染逻辑 -->
```

## 4. 预期效果

- 计算逻辑和渲染逻辑分离，代码结构更清晰
- 统计结果按列分类，方便进行批量处理和分析
- 无效数据用null表示，便于后续处理和判断
- 组件职责更单一，只负责渲染
- 提高代码的可维护性和可测试性

## 5. 实施顺序

1. 创建新的类型定义
2. 重构calculations.ts，分离计算和格式化逻辑
3. 创建formatters.ts，存放格式化函数
4. 重构TaskTable.svelte，修改props和渲染逻辑
5. 调整父组件，添加统计逻辑并传递统计结果
6. 测试重构后的代码，确保功能正常

## 6. 注意事项

- 确保所有计算函数都返回正确的null值
- 确保渲染函数正确处理null值
- 确保按列分类的统计结果顺序与任务列表一致
- 确保总计结果计算正确
- 保持向后兼容性，避免破坏现有功能
